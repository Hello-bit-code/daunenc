<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오프라인 물량/작업 보고</title>

  <style>
    :root{
      --bg:#0b1020;
      --surface: rgba(17, 24, 39, .86);
      --surface2: rgba(15, 23, 42, .72);
      --line: rgba(51, 65, 85, .62);
      --text:#e5e7eb;
      --muted: rgba(148, 163, 184, .92);
      --danger:#fb7185;
      --shadow: 0 20px 48px rgba(0,0,0,.42);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
              "Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic", sans-serif;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      letter-spacing: -0.2px;
      background:
        radial-gradient(1200px 780px at 20% 10%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(900px 560px at 90% 20%, rgba(52,211,153,.12), transparent 55%),
        radial-gradient(900px 560px at 40% 95%, rgba(251,113,133,.10), transparent 60%),
        var(--bg);
    }
    .wrap{ max-width: 1120px; margin: 22px auto 80px; padding: 0 18px; }

    .topbar{ display:flex; gap:14px; align-items:flex-start; justify-content: space-between; margin-bottom: 14px; }
    .brand{ display:flex; gap:12px; align-items:center; }
    .logo{
      width:44px; height:44px; border-radius:16px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(52,211,153,.86));
      box-shadow: 0 14px 34px rgba(96,165,250,.22);
      position: relative; flex:0 0 auto;
    }
    .logo:after{
      content:""; position:absolute; inset:10px; border-radius:12px;
      background: rgba(17,24,39,.86);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }
    .title h1{ margin:0; font-size:18px; line-height:1.15; }
    .title .sub{ margin-top:5px; font-size:12.5px; color: var(--muted); line-height:1.35; white-space:pre-line; }

    .card{
      background: linear-gradient(180deg, var(--surface), var(--surface2));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card + .card{ margin-top:14px; }

    .cardHead{ display:flex; gap:12px; align-items:center; justify-content: space-between; margin-bottom:12px; }
    .cardHead .left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .cardHead h2{ margin:0; font-size:14.5px; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 999px;
      border: 1px solid var(--line); background: rgba(11, 15, 26, .35);
      font-size: 12px; color: var(--muted); user-select:none; white-space:nowrap;
    }
    .pill strong{ color: var(--text); font-weight:700; }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .field label{ display:block; margin: 0 0 6px; font-size:12px; color: var(--muted); }
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(51,65,85,.85);
      background: rgba(11,15,26,.48);
      color: var(--text);
      outline:none;
      transition: border .15s ease, background .15s ease;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(96,165,250,.85);
      background: rgba(11,15,26,.62);
    }
    input::placeholder{ color: rgba(148,163,184,.62); }

    textarea{
      min-height: 170px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.5;
      white-space: pre;
    }

    .hint{ font-size:12px; color: var(--muted); line-height:1.45; }
    .hr{ height:1px; background: rgba(51,65,85,.75); margin: 14px 0; }

    .btn{
      border: 1px solid rgba(51,65,85,.85);
      background: rgba(11,15,26,.50);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      white-space:nowrap;
      transition: border .15s ease, background .15s ease, transform .05s ease;
      touch-action: manipulation;
    }
    .btn:hover{ border-color: rgba(96,165,250,.55); background: rgba(11,15,26,.72); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, rgba(96,165,250,.98), rgba(52,211,153,.86));
      color:#07101d;
      font-weight: 800;
    }
    .btn.danger{ border-color: rgba(251,113,133,.55); }
    .btn.small{ padding: 8px 10px; border-radius: 10px; font-size: 12.5px; }

    .bar{ display:flex; gap:10px; flex-wrap: wrap; justify-content: space-between; align-items:center; }
    .barRight{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .works{ display:flex; flex-direction: column; gap: 12px; }
    .work{
      border: 1px solid rgba(51,65,85,.75);
      border-radius: var(--radius);
      background: rgba(11,15,26,.30);
      padding: 12px;
    }
    .workHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .workHead .left{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .workTitle{ font-size: 13.5px; font-weight: 900; }
    .tag{
      font-size: 12px;
      color: var(--muted);
      border: 1px solid rgba(51,65,85,.65);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(17,24,39,.42);
    }

    .groups{ display:flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .group{
      border: 1px solid rgba(51,65,85,.70);
      border-radius: var(--radius2);
      background: rgba(11,15,26,.28);
      padding: 12px;
    }
    .groupHead{
      display:flex; align-items:center; justify-content: space-between;
      gap: 10px; flex-wrap: wrap; margin-bottom: 10px;
    }
    .groupHead .left{ display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .groupTitle{ font-size: 13px; font-weight: 850; }

    .items{ display:flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .item{
      border: 1px solid rgba(51,65,85,.65);
      border-radius: var(--radius2);
      background: rgba(11,15,26,.34);
      padding: 12px;
    }
    .itemGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      align-items: end;
    }
    .chips{ display:flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .chip{
      font-size: 12px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(51,65,85,.70);
      background: rgba(17,24,39,.62);
      color: var(--muted);
    }
    .chip b{ color: var(--text); }

    .toast{
      position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%);
      background: rgba(17,24,39,.92);
      border: 1px solid rgba(51,65,85,.85);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
      font-size: 13px;
      max-width: min(720px, calc(100% - 24px));
      z-index: 9999;
    }

    .watermark{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 10px;
      display:flex;
      justify-content:center;
      pointer-events:none;
      z-index: 1;
      opacity: .55;
    }
    .watermark .wmCard{
      pointer-events:none;
      font-size: 11px;
      color: rgba(148,163,184,.9);
      border: 1px solid rgba(51,65,85,.55);
      background: rgba(11,15,26,.35);
      border-radius: 999px;
      padding: 7px 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      text-align:center;
      line-height: 1.25;
      white-space: pre-line;
    }

    @media (max-width: 820px){
      .wrap{ padding: 0 14px; }
      .topbar{ flex-direction: column; align-items:flex-start; }

      input, select, textarea{ font-size:16px; padding: 12px 12px; border-radius: 14px; }
      .btn{ padding: 12px 13px; font-size:14px; border-radius: 14px; }
      .btn.small{ padding: 10px 12px; font-size:13px; border-radius: 12px; }

      .grid{ grid-template-columns: 1fr 1fr; }
      .span12,.span6{ grid-column: 1 / -1 !important; }
      .span3{ grid-column: span 1 !important; }

      .itemGrid{ grid-template-columns: 1fr 1fr; }
      .full{ grid-column: 1 / -1 !important; }
      .half{ grid-column: span 1 !important; }
      .btnBar{ grid-column: 1 / -1 !important; justify-content:flex-end; }

      .watermark{ bottom: 8px; }
      .watermark .wmCard{ font-size: 10.5px; padding: 7px 10px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <h1>오프라인 물량/작업 보고</h1>
        <div class="sub">서버 없이 사용 · 기기(LocalStorage) 저장
입력팁: 300*150*3000 / 300×150×3000 / 300x150x3000</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn danger" id="btnReset">초기화</button>
    </div>
  </div>

  <!-- 작업(=기본정보 세트) -->
  <section class="card">
    <div class="cardHead">
      <div class="left">
        <h2>작업(기본 정보)</h2>
        <span class="pill"><strong id="countWorks">0</strong> 작업</span>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnAddWork">작업 추가</button>
        <button class="btn" id="btnSaveAll">저장</button>
      </div>
    </div>

    <div class="hint" style="margin-bottom:10px;">
      ‘작업 추가’는 <b>기본 정보 세트(도면/날짜/공정지역/메모)</b>가 하나 더 생성됩니다.
    </div>

    <div class="works" id="works"></div>
  </section>

  <!-- 결과 -->
  <section class="card">
    <div class="cardHead">
      <div class="left">
        <h2>금일 작업 결과(카톡용)</h2>
        <span class="pill">선택/전체 출력</span>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" id="btnCopy">내용 복사</button>
      </div>
    </div>

    <textarea id="output" readonly placeholder="‘선택 작업 결과 생성’ 또는 ‘전체 작업 결과 생성’을 누르세요."></textarea>

    <div class="hr"></div>

    <div class="bar">
      <div class="hint">복사 후 카톡에 붙여넣기 하세요.</div>
      <div class="barRight">
        <span class="pill">선택: <strong id="selectedWorkLabel">-</strong></span>
        <button class="btn" id="btnGenerateSelected">선택 작업 결과 생성</button>
        <button class="btn primary" id="btnGenerateAll">전체 작업 결과 생성</button>
      </div>
    </div>
  </section>
</div>

<div class="watermark" aria-hidden="true">
  <div class="wmCard">제작 : 황정운
수정요청 : 010-5031-9447</div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  const UNIT_OPTIONS = ["EA","M","SET","POINT","ROLL","PCS","본"];
  const CATEGORY_OPTIONS = ["TRAY","CONDUIT","ELP","SUPPORT","U-CHANNEL","C-CHANNEL","ANGLE","FITTING","BOX","FASTENER","PAINT","OTHER"];
  const DEFAULT_AREAS = ["PIPE RACK","전기실 1층","전기실 2층","SUBSTATION","UG","TK AREA","에틸렌 B구역"];

  const MATERIAL_DICT = [
    { aliases:["전선관","스틸 전선관","STEEL CONDUIT","STEEL CONDUIT PIPE","CONDUIT","CONDUIT PIPE"], canonical:"STEEL CONDUIT", category:"CONDUIT"},
    { aliases:["CD","CD관","CD PIPE","CD CONDUIT","22C","28C","36C","54C"], canonical:"CD CONDUIT", category:"CONDUIT"},
    { aliases:["후렉시블","후렉쉬블","FLEX","FLEXIBLE","FLEXIBLE CONDUIT"], canonical:"FLEXIBLE CONDUIT", category:"CONDUIT"},
    { aliases:["ELP","ELP 배관","ELP PIPE"], canonical:"ELP", category:"ELP"},
    { aliases:["트레이","케이블트레이","CABLE TRAY","TRAY","CABLETRAY"], canonical:"CABLE TRAY", category:"TRAY"},
    { aliases:["서포트","SUPPORT","LIGHTING SUPPORT","TRAY SUPPORT"], canonical:"SUPPORT", category:"SUPPORT"},
    { aliases:["앵글","ANGLE"], canonical:"ANGLE", category:"ANGLE"},
    { aliases:["유니온","UNION"], canonical:"UNION", category:"FITTING"},
    { aliases:["레듀샤","REDUCER","REDUCER LEFT","REDUCER RIGHT"], canonical:"REDUCER", category:"FITTING"},
    { aliases:["클램프","CLAMP"], canonical:"CLAMP", category:"FASTENER"},
    { aliases:["라운드박스","ROUND BOX"], canonical:"ROUND BOX", category:"BOX"},
    { aliases:["풀박스","PULL BOX","FULL BOX"], canonical:"PULL BOX", category:"BOX"},
    { aliases:["도장","페인트","PAINT","COATING"], canonical:"PAINT", category:"PAINT"},
    { aliases:["U찬넬","U 찬넬","U-CHANNEL","U CHANNEL","UNISTRUT","유니스트럿","STRUT CHANNEL"], canonical:"U-CHANNEL", category:"U-CHANNEL"},
    { aliases:["C찬넬","C 찬넬","C-CHANNEL","C CHANNEL","찬넬","채널","CHANNEL"], canonical:"C-CHANNEL", category:"C-CHANNEL"},
  ];

  const $ = (sel) => document.querySelector(sel);

  function toast(msg){
    const t = $("#toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(toast._timer);
    toast._timer = setTimeout(()=> t.style.display = "none", 2200);
  }

  function todayISO(){
    const d = new Date();
    const tz = d.getTimezoneOffset() * 60000;
    return new Date(d.getTime() - tz).toISOString().slice(0,10);
  }

  function normalizeText(s){
    return (s||"").trim().replace(/\s+/g, " ").toUpperCase();
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function mapMaterial(input){
    const raw = (input||"").trim();
    if(!raw) return { canonical:"", category:"", confidence:"" };

    if(/^\d+(?:\.\d+)?\s*C$/i.test(raw)){
      return { canonical:"CD CONDUIT", category:"CONDUIT", confidence:"자동분류" };
    }

    const up = normalizeText(raw);
    const compact = up.replace(/[\s\-_/]/g, "");

    for(const entry of MATERIAL_DICT){
      for(const a of entry.aliases){
        const au = normalizeText(a);
        if(up === au) return { canonical: entry.canonical, category: entry.category, confidence:"정확" };
      }
    }
    for(const entry of MATERIAL_DICT){
      for(const a of entry.aliases){
        const au = normalizeText(a);
        if(au && up.includes(au)) return { canonical: entry.canonical, category: entry.category, confidence:"포함" };
      }
    }
    for(const entry of MATERIAL_DICT){
      for(const a of entry.aliases){
        const au = normalizeText(a).replace(/[\s\-_/]/g, "");
        if(au && compact.includes(au)) return { canonical: entry.canonical, category: entry.category, confidence:"유사" };
      }
    }
    return { canonical: raw.toUpperCase(), category:"OTHER", confidence:"원문" };
  }

  function parseSpec(spec){
    const s = (spec||"").trim();
    if(!s) return { pretty:"" };
    const m = s.replace(/,/g,"").match(/^(\d+(?:\.\d+)?)\s*[xX×\*]\s*(\d+(?:\.\d+)?)\s*(?:[xX×\*]\s*(\d+(?:\.\d+)?))?\s*$/);
    if(m){
      const parts = [m[1], m[2]].concat(m[3] ? [m[3]] : []);
      return { pretty: parts.join("×") };
    }
    return { pretty: s };
  }

  const LS_KEY = "worklog_offline_multiwork_v2";
  const state = { works: [], selectedWorkId: "" };

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function newMaterial(){
    return { materialInput:"", canonical:"", category:"OTHER", spec:"", qty:"", unit:"EA", note:"", lockAuto:false };
  }
  function newGroup(){ return { areaDetail:"", items:[ newMaterial() ] }; }
  function newWork(){
    const id = uid();
    return {
      id,
      drawing: "",
      date: todayISO(),
      area: "",
      memo: "",
      history: { drawings: [], areas: DEFAULT_AREAS.slice() },
      groups: [ newGroup() ],
    };
  }

  function load(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      try{
        const data = JSON.parse(raw);
        if(data && Array.isArray(data.works)) state.works = data.works;
        if(data && typeof data.selectedWorkId === "string") state.selectedWorkId = data.selectedWorkId;
      }catch(e){}
    }
    if(state.works.length === 0){
      const w = newWork();
      state.works.push(w);
      state.selectedWorkId = w.id;
      saveLS();
    }
    if(!state.selectedWorkId || !state.works.some(w => w.id === state.selectedWorkId)){
      state.selectedWorkId = state.works[0].id;
    }
  }

  function saveLS(){
    localStorage.setItem(LS_KEY, JSON.stringify({ works: state.works, selectedWorkId: state.selectedWorkId }));
  }

  function pushUnique(arr, val, max=80){
    val = (val||"").trim();
    if(!val) return;
    const idx = arr.findIndex(v => normalizeText(v) === normalizeText(val));
    if(idx >= 0) arr.splice(idx,1);
    arr.unshift(val);
    if(arr.length > max) arr.length = max;
  }

  function selectedWork(){
    return state.works.find(w => w.id === state.selectedWorkId) || state.works[0];
  }

  function updateCounts(){
    $("#countWorks").textContent = String(state.works.length);
    const sw = selectedWork();
    $("#selectedWorkLabel").textContent = sw ? `작업 ${state.works.findIndex(x=>x.id===sw.id)+1}` : "-";
  }

  function ensureWorkHasAtLeastOneGroup(w){
    if(!Array.isArray(w.groups) || w.groups.length === 0) w.groups = [ newGroup() ];
  }

  function render(){
    const host = $("#works");
    host.innerHTML = "";

    state.works.forEach((w, wi) => {
      const isSel = w.id === state.selectedWorkId;

      const workEl = document.createElement("div");
      workEl.className = "work";
      workEl.dataset.w = w.id;

      const groupCount = (w.groups || []).length;

      workEl.innerHTML = `
        <div class="workHead">
          <div class="left">
            <div class="workTitle">작업 ${wi+1}</div>
            <div class="tag">구역 ${groupCount}개</div>
            <div class="tag">${isSel ? "선택됨" : "미선택"}</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn small js-selectWork" type="button">${isSel ? "선택됨" : "이 작업 선택"}</button>
            <button class="btn small danger js-delWork" type="button">작업 삭제</button>
          </div>
        </div>

        <div class="grid">
          <div class="field span6" style="grid-column: span 6;">
            <label>도면 Num. (자동완성)</label>
            <input class="js-drawing" placeholder="예: 2153-EL-CTL-0001 Rev.1" list="dl_${w.id}" value="${esc(w.drawing||"")}" />
            <datalist id="dl_${w.id}">${(w.history?.drawings||[]).map(x=>`<option value="${esc(x)}"></option>`).join("")}</datalist>
          </div>

          <div class="field span3" style="grid-column: span 3;">
            <label>날짜</label>
            <input class="js-date" type="date" value="${esc(w.date||todayISO())}" />
          </div>

          <div class="field span3" style="grid-column: span 3;">
            <label>공정지역(Area)</label>
            <input class="js-area" placeholder="예: PIPE RACK / SUBSTATION / 전기실 1층" list="al_${w.id}" value="${esc(w.area||"")}" />
            <datalist id="al_${w.id}">${(w.history?.areas||DEFAULT_AREAS).map(x=>`<option value="${esc(x)}"></option>`).join("")}</datalist>
          </div>

          <div class="field span12" style="grid-column: span 12;">
            <label>메모(선택)</label>
            <input class="js-memo" placeholder="예: 우천 / 야간 / 특이사항" value="${esc(w.memo||"")}" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="bar">
          <div class="hint">이 작업의 작업구역 상세 (구역/자재)</div>
          <div class="barRight">
            <button class="btn js-addGroup" type="button">구역 추가</button>
            <button class="btn js-addMat" type="button">자재 추가</button>
          </div>
        </div>

        <div class="groups js-groups"></div>
      `;

      host.appendChild(workEl);

      const groupsHost = workEl.querySelector(".js-groups");
      (w.groups || []).forEach((g, gi) => {
        const groupEl = document.createElement("div");
        groupEl.className = "group";
        groupEl.dataset.w = w.id;
        groupEl.dataset.g = String(gi);

        const itemCount = (g.items || []).length;

        groupEl.innerHTML = `
          <div class="groupHead">
            <div class="left">
              <div class="groupTitle">구역 ${gi+1}</div>
              <div class="tag">자재 ${itemCount}건</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn small js-addMatInGroup" type="button">자재 추가</button>
              <button class="btn small danger js-delGroup" type="button">구역 삭제</button>
            </div>
          </div>

          <div class="grid">
            <div class="field span12" style="grid-column: span 12;">
              <label>작업구역 상세</label>
              <input class="js-areaDetail" placeholder="예: PIPE RACK / 구간 30~32 / Column 8~25" value="${esc(g.areaDetail||"")}" />
            </div>
          </div>

          <div class="items js-items"></div>
        `;

        groupsHost.appendChild(groupEl);

        const itemsHost = groupEl.querySelector(".js-items");
        (g.items || []).forEach((it, ii) => {
          const mapped = mapMaterial(it.materialInput);
          if(it.materialInput && !it.lockAuto){
            it.canonical = mapped.canonical;
            it.category = mapped.category || "OTHER";
          }

          const specPretty = parseSpec(it.spec).pretty;

          const itemEl = document.createElement("div");
          itemEl.className = "item";
          itemEl.dataset.w = w.id;
          itemEl.dataset.g = String(gi);
          itemEl.dataset.i = String(ii);

          itemEl.innerHTML = `
            <div class="itemGrid">
              <div class="field full" style="grid-column: span 3;">
                <label>자재명(자유 입력)</label>
                <input class="js-mat" placeholder="예: U찬넬 / C찬넬 / 전선관 / 트레이" value="${esc(it.materialInput||"")}" />
              </div>

              <div class="field full" style="grid-column: span 2;">
                <label>표준 자재명(수정 가능)</label>
                <input class="js-canon" placeholder="예: U-CHANNEL / C-CHANNEL" value="${esc(it.canonical||"")}" />
              </div>

              <div class="field half" style="grid-column: span 1;">
                <label>카테고리(수정 가능)</label>
                <select class="js-cat">
                  ${CATEGORY_OPTIONS.map(c => `<option value="${c}" ${c===it.category ? "selected":""}>${c}</option>`).join("")}
                </select>
              </div>

              <div class="field half" style="grid-column: span 2;">
                <label>규격(Spec)</label>
                <input class="js-spec" placeholder="예: 600*150*3000 / 28MM / 28C" value="${esc(it.spec||"")}" />
              </div>

              <div class="field half" style="grid-column: span 1;">
                <label>수량</label>
                <input class="js-qty" inputmode="decimal" placeholder="예: 12" value="${esc(it.qty||"")}" />
              </div>

              <div class="field half" style="grid-column: span 1;">
                <label>단위</label>
                <select class="js-unit">
                  ${["EA","M","SET","POINT","ROLL","PCS","본"].map(u => `<option value="${u}" ${u===it.unit ? "selected":""}>${u}</option>`).join("")}
                </select>
              </div>

              <div class="field full" style="grid-column: span 11;">
                <label>구간/비고(선택)</label>
                <input class="js-note" placeholder="예: welding / 설치 / 철거 / 보강" value="${esc(it.note||"")}" />
              </div>

              <div class="btnBar" style="grid-column: span 1; display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn small js-auto" type="button" title="자동 제안 적용">자동</button>
                <button class="btn small js-dup" type="button">복제</button>
                <button class="btn small danger js-delItem" type="button">삭제</button>
              </div>
            </div>

            <div class="chips">
              <span class="chip"><b>매핑</b> ${esc(mapped.confidence || "-")}</span>
              <span class="chip"><b>규격</b> ${esc(specPretty || "-")}</span>
              <span class="chip"><b>자동잠금</b> ${it.lockAuto ? "ON" : "OFF"}</span>
            </div>
          `;
          itemsHost.appendChild(itemEl);
        });
      });
    });

    updateCounts();
    saveLS();
  }

  function addWork(){
    const w = newWork();
    state.works.push(w);
    state.selectedWorkId = w.id;
    render();
    toast("작업을 추가했습니다.");
  }

  function addGroupToWork(workId){
    const w = state.works.find(x => x.id === workId);
    if(!w) return;
    w.groups = w.groups || [];
    w.groups.push(newGroup());
    render();
    toast("구역을 추가했습니다.");
  }

  function addMaterialToLastGroupOfWork(workId){
    const w = state.works.find(x => x.id === workId);
    if(!w) return;
    ensureWorkHasAtLeastOneGroup(w);
    const g = w.groups[w.groups.length - 1];
    g.items = g.items || [];
    g.items.push(newMaterial());
    render();
    toast("자재를 추가했습니다. (마지막 구역)");
  }

  // ✅ 출력: 작업 1건
  function generateOutputForWork(w){
    if(!w) return "";
    const date = w.date || todayISO();
    const drawing = (w.drawing||"").trim();
    const baseArea = (w.area||"").trim() || "(미지정)";

    const header = [
      `[금일 작업내용]${drawing ? ` (도면: ${drawing})` : ""}`,
      `- 공정지역: ${baseArea}`,
      w.memo ? `- 메모: ${w.memo}` : null,
      `- 날짜: ${date}`,
      ``
    ].filter(Boolean).join("\n");

    let n = 1;
    const lines = [];

    (w.groups || []).forEach((g) => {
      const areaDetail = (g.areaDetail||"").trim();
      (g.items || []).forEach((it) => {
        const canonical = (it.canonical||"").trim();
        const matFallback = (it.materialInput||"").trim().toUpperCase();
        const mat = canonical || matFallback;

        const specPretty = parseSpec(it.spec).pretty;
        const qty = (it.qty||"").toString().trim();
        const unit = (it.unit||"").trim();
        const note = (it.note||"").trim();

        // ✅ “수량만 입력” 같은 케이스도 누락되지 않게 조건 완화
        const isEmpty = !mat && !specPretty && !qty && !note && !areaDetail;
        if(isEmpty) return;

        const areaPart = areaDetail ? ` (구간: ${areaDetail})` : "";
        const specPart = specPretty ? ` ${specPretty}` : "";
        const qtyPart  = (qty && unit) ? `  ${qty}${unit}` : (qty ? `  ${qty}` : "");
        const notePart = note ? `  (비고: ${note})` : "";

        lines.push(`${n}) ${mat}${specPart}${qtyPart}${areaPart}${notePart}`.replace(/\s+/g," ").trim());
        n++;
      });
    });

    const body = lines.length ? lines.join("\n") : "(자재/작업 내역이 없습니다)";
    return header + body;
  }

  // ✅ 출력: 전체 작업(모든 기본정보 세트)
  function generateOutputAllWorks(){
    const blocks = [];
    state.works.forEach((w, idx) => {
      const block = generateOutputForWork(w);
      // 작업 구분 라벨(카톡에서 보기 좋게)
      blocks.push(`==== 작업 ${idx+1} ====\n` + block);
    });
    return blocks.join("\n\n");
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("클립보드에 복사했습니다.");
      return true;
    }catch(e){
      const out = $("#output");
      out.focus(); out.select();
      try{
        document.execCommand("copy");
        toast("복사했습니다. (호환 모드)");
        return true;
      }catch(_){
        toast("복사 실패: 직접 선택 후 복사하세요.");
        return false;
      }
    }
  }

  function bindStaticButtons(){
    $("#btnAddWork").addEventListener("click", addWork);

    $("#btnSaveAll").addEventListener("click", () => {
      saveLS();
      toast("저장했습니다. (이 기기 저장)");
    });

    $("#btnGenerateSelected").addEventListener("click", () => {
      const w = selectedWork();
      $("#output").value = generateOutputForWork(w);
      toast("선택 작업 결과를 생성했습니다.");
    });

    $("#btnGenerateAll").addEventListener("click", () => {
      $("#output").value = generateOutputAllWorks();
      toast("전체 작업 결과를 생성했습니다.");
    });

    $("#btnCopy").addEventListener("click", async () => {
      const text = $("#output").value || generateOutputAllWorks();
      $("#output").value = text;
      await copyToClipboard(text);
    });

    $("#btnReset").addEventListener("click", () => {
      const ok = confirm("이 기기에 저장된 모든 데이터가 삭제됩니다. 계속할까요?");
      if(!ok) return;
      localStorage.removeItem(LS_KEY);
      location.reload();
    });
  }

  function bindDynamic(){
    const host = $("#works");

    host.addEventListener("click", (e) => {
      const workEl = e.target.closest(".work");
      if(!workEl) return;
      const workId = workEl.dataset.w;
      const w = state.works.find(x => x.id === workId);
      if(!w) return;

      if(e.target.closest(".js-selectWork")){
        state.selectedWorkId = workId;
        render();
        toast("선택 작업을 변경했습니다.");
        return;
      }

      if(e.target.closest(".js-delWork")){
        const idx = state.works.findIndex(x => x.id === workId);
        state.works.splice(idx, 1);
        if(state.works.length === 0){
          const nw = newWork();
          state.works.push(nw);
          state.selectedWorkId = nw.id;
        }else if(state.selectedWorkId === workId){
          state.selectedWorkId = state.works[0].id;
        }
        render();
        toast("작업을 삭제했습니다.");
        return;
      }

      if(e.target.closest(".js-addGroup")){
        addGroupToWork(workId);
        return;
      }

      if(e.target.closest(".js-addMat")){
        addMaterialToLastGroupOfWork(workId);
        return;
      }

      const groupEl = e.target.closest(".group");
      if(groupEl){
        const gi = Number(groupEl.dataset.g);
        const g = (w.groups || [])[gi];
        if(!g) return;

        if(e.target.closest(".js-delGroup")){
          w.groups.splice(gi, 1);
          ensureWorkHasAtLeastOneGroup(w);
          render();
          toast("구역을 삭제했습니다.");
          return;
        }

        if(e.target.closest(".js-addMatInGroup")){
          g.items = g.items || [];
          g.items.push(newMaterial());
          render();
          toast("자재를 추가했습니다.");
          return;
        }

        const itemEl = e.target.closest(".item");
        if(itemEl){
          const ii = Number(itemEl.dataset.i);
          const it = (g.items || [])[ii];
          if(!it) return;

          if(e.target.closest(".js-delItem")){
            g.items.splice(ii, 1);
            if(g.items.length === 0) g.items.push(newMaterial());
            render();
            toast("자재를 삭제했습니다.");
            return;
          }

          if(e.target.closest(".js-dup")){
            const copy = JSON.parse(JSON.stringify(it));
            g.items.splice(ii+1, 0, copy);
            render();
            toast("자재를 복제했습니다.");
            return;
          }

          if(e.target.closest(".js-auto")){
            it.lockAuto = false;
            const mapped = mapMaterial(it.materialInput);
            it.canonical = mapped.canonical;
            it.category = mapped.category || "OTHER";
            render();
            toast("자동 제안을 적용했습니다.");
            return;
          }
        }
      }
    });

    host.addEventListener("input", (e) => {
      const workEl = e.target.closest(".work");
      if(!workEl) return;
      const workId = workEl.dataset.w;
      const w = state.works.find(x => x.id === workId);
      if(!w) return;

      if(e.target.classList.contains("js-drawing")){
        w.drawing = e.target.value;
        saveLS();
        return;
      }
      if(e.target.classList.contains("js-date")){
        w.date = e.target.value;
        saveLS();
        return;
      }
      if(e.target.classList.contains("js-area")){
        w.area = e.target.value;
        pushUnique(w.history.areas, w.area, 150);
        saveLS();
        return;
      }
      if(e.target.classList.contains("js-memo")){
        w.memo = e.target.value;
        saveLS();
        return;
      }

      const groupEl = e.target.closest(".group");
      if(!groupEl) return;
      const gi = Number(groupEl.dataset.g);
      const g = (w.groups || [])[gi];
      if(!g) return;

      if(e.target.classList.contains("js-areaDetail")){
        g.areaDetail = e.target.value;
        saveLS();
        return;
      }

      const itemEl = e.target.closest(".item");
      if(!itemEl) return;
      const ii = Number(itemEl.dataset.i);
      const it = (g.items || [])[ii];
      if(!it) return;

      if(e.target.classList.contains("js-mat")){
        it.materialInput = e.target.value;
        const mapped = mapMaterial(it.materialInput);
        if(!it.lockAuto){
          it.canonical = mapped.canonical;
          it.category = mapped.category || "OTHER";
        }
        saveLS();
        return;
      }

      if(e.target.classList.contains("js-canon")){
        it.canonical = e.target.value;
        it.lockAuto = true;
        saveLS();
        return;
      }

      if(e.target.classList.contains("js-spec")){
        it.spec = e.target.value;
        saveLS();
        return;
      }

      if(e.target.classList.contains("js-qty")){
        it.qty = e.target.value;
        saveLS();
        return;
      }

      if(e.target.classList.contains("js-note")){
        it.note = e.target.value;
        saveLS();
        return;
      }
    });

    host.addEventListener("change", (e) => {
      const workEl = e.target.closest(".work");
      if(!workEl) return;
      const workId = workEl.dataset.w;
      const w = state.works.find(x => x.id === workId);
      if(!w) return;

      if(e.target.classList.contains("js-drawing")){
        pushUnique(w.history.drawings, w.drawing, 120);
        saveLS();
        render();
        return;
      }

      const itemEl = e.target.closest(".item");
      if(!itemEl) return;

      const groupEl = e.target.closest(".group");
      if(!groupEl) return;
      const gi = Number(groupEl.dataset.g);
      const g = (w.groups || [])[gi];
      if(!g) return;

      const ii = Number(itemEl.dataset.i);
      const it = (g.items || [])[ii];
      if(!it) return;

      if(e.target.classList.contains("js-cat")){
        it.category = e.target.value;
        it.lockAuto = true;
        saveLS();
        return;
      }

      if(e.target.classList.contains("js-unit")){
        it.unit = e.target.value;
        saveLS();
        return;
      }
    });
  }

  // Boot
  load();
  render();
  bindStaticButtons();
  bindDynamic();
})();
</script>
</body>
</html>